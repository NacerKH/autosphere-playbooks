---
# Collect Diagnostics Playbook
# Comprehensive diagnostic data collection for incident investigation
# Part of AutoSphere incident response system

- name: Collect OpenStack Diagnostics
  hosts: openstack_controllers
  gather_facts: yes
  become: yes
  vars:
    diag_dir: "/var/log/autosphere/diagnostics"
    diag_timestamp: "{{ ansible_date_time.epoch }}"
    log_hours: 2

  tasks:
    - name: Create diagnostics directory
      file:
        path: "{{ diag_dir }}/{{ diag_timestamp }}"
        state: directory
        mode: '0755'

    - name: Collect system information
      shell: |
        uname -a > {{ diag_dir }}/{{ diag_timestamp }}/system-info.txt
        uptime >> {{ diag_dir }}/{{ diag_timestamp }}/system-info.txt
        free -h >> {{ diag_dir }}/{{ diag_timestamp }}/system-info.txt
        df -h >> {{ diag_dir }}/{{ diag_timestamp }}/system-info.txt
      changed_when: false

    - name: Collect Docker information
      shell: |
        docker info > {{ diag_dir }}/{{ diag_timestamp }}/docker-info.txt
        docker ps -a > {{ diag_dir }}/{{ diag_timestamp }}/docker-containers.txt
        docker stats --no-stream > {{ diag_dir }}/{{ diag_timestamp }}/docker-stats.txt
      changed_when: false

    - name: Collect RabbitMQ diagnostics
      shell: |
        docker exec rabbitmq rabbitmqctl cluster_status > {{ diag_dir }}/{{ diag_timestamp }}/rabbitmq-cluster.txt
        docker exec rabbitmq rabbitmqctl list_queues name messages consumers > {{ diag_dir }}/{{ diag_timestamp }}/rabbitmq-queues.txt
        docker exec rabbitmq rabbitmqctl list_connections > {{ diag_dir }}/{{ diag_timestamp }}/rabbitmq-connections.txt
        docker logs rabbitmq --since {{ log_hours }}h > {{ diag_dir }}/{{ diag_timestamp }}/rabbitmq-logs.txt 2>&1
      ignore_errors: yes
      changed_when: false

    - name: Collect MariaDB/Galera diagnostics
      shell: |
        docker exec mariadb mysql -e "SHOW STATUS LIKE 'wsrep%'" > {{ diag_dir }}/{{ diag_timestamp }}/galera-status.txt
        docker exec mariadb mysql -e "SHOW PROCESSLIST" > {{ diag_dir }}/{{ diag_timestamp }}/mysql-processlist.txt
        docker logs mariadb --since {{ log_hours }}h > {{ diag_dir }}/{{ diag_timestamp }}/mariadb-logs.txt 2>&1
      ignore_errors: yes
      changed_when: false

    - name: Collect Nova diagnostics
      shell: |
        docker exec nova_api nova-manage service list > {{ diag_dir }}/{{ diag_timestamp }}/nova-services.txt
        docker exec nova_api nova hypervisor-list > {{ diag_dir }}/{{ diag_timestamp }}/nova-hypervisors.txt
        docker logs nova_api --since {{ log_hours }}h > {{ diag_dir }}/{{ diag_timestamp }}/nova-api-logs.txt 2>&1
        docker logs nova_scheduler --since {{ log_hours }}h > {{ diag_dir }}/{{ diag_timestamp }}/nova-scheduler-logs.txt 2>&1
        docker logs nova_conductor --since {{ log_hours }}h > {{ diag_dir }}/{{ diag_timestamp }}/nova-conductor-logs.txt 2>&1
      ignore_errors: yes
      changed_when: false

    - name: Collect Neutron diagnostics
      shell: |
        docker exec neutron_server neutron agent-list > {{ diag_dir }}/{{ diag_timestamp }}/neutron-agents.txt
        docker exec neutron_server openstack network list > {{ diag_dir }}/{{ diag_timestamp }}/neutron-networks.txt
        docker logs neutron_server --since {{ log_hours }}h > {{ diag_dir }}/{{ diag_timestamp }}/neutron-server-logs.txt 2>&1
        docker logs neutron_l3_agent --since {{ log_hours }}h > {{ diag_dir }}/{{ diag_timestamp }}/neutron-l3-logs.txt 2>&1
        docker logs neutron_dhcp_agent --since {{ log_hours }}h > {{ diag_dir }}/{{ diag_timestamp }}/neutron-dhcp-logs.txt 2>&1
      ignore_errors: yes
      changed_when: false

    - name: Collect Cinder diagnostics
      shell: |
        docker exec cinder_api cinder service-list > {{ diag_dir }}/{{ diag_timestamp }}/cinder-services.txt
        docker exec cinder_api openstack volume list > {{ diag_dir }}/{{ diag_timestamp }}/cinder-volumes.txt
        docker logs cinder_api --since {{ log_hours }}h > {{ diag_dir }}/{{ diag_timestamp }}/cinder-api-logs.txt 2>&1
        docker logs cinder_scheduler --since {{ log_hours }}h > {{ diag_dir }}/{{ diag_timestamp }}/cinder-scheduler-logs.txt 2>&1
      ignore_errors: yes
      changed_when: false

    - name: Search for error patterns
      shell: |
        find /var/log/kolla -name "*.log" -mmin -120 -exec grep -l "ERROR\|CRITICAL\|TimeoutError\|MessagingTimeout" {} \; > {{ diag_dir }}/{{ diag_timestamp }}/error-files.txt
        grep -r "TimeoutError\|MessagingTimeout" /var/log/kolla --include="*.log" | tail -100 > {{ diag_dir }}/{{ diag_timestamp }}/timeout-errors.txt 2>&1
        grep -r "ConnectionRefused\|Connection refused" /var/log/kolla --include="*.log" | tail -100 > {{ diag_dir }}/{{ diag_timestamp }}/connection-errors.txt 2>&1
      ignore_errors: yes
      changed_when: false

    - name: Collect HAProxy stats
      shell: |
        echo "show stat" | socat stdio /var/lib/kolla/haproxy/haproxy.sock > {{ diag_dir }}/{{ diag_timestamp }}/haproxy-stats.txt 2>&1
        echo "show info" | socat stdio /var/lib/kolla/haproxy/haproxy.sock > {{ diag_dir }}/{{ diag_timestamp }}/haproxy-info.txt 2>&1
      ignore_errors: yes
      changed_when: false

    - name: Collect network diagnostics
      shell: |
        ip addr show > {{ diag_dir }}/{{ diag_timestamp }}/ip-addresses.txt
        ip route show > {{ diag_dir }}/{{ diag_timestamp }}/ip-routes.txt
        netstat -tulpn > {{ diag_dir }}/{{ diag_timestamp }}/netstat.txt
        ss -s > {{ diag_dir }}/{{ diag_timestamp }}/socket-stats.txt
      ignore_errors: yes
      changed_when: false

    - name: Create diagnostic archive
      archive:
        path: "{{ diag_dir }}/{{ diag_timestamp }}"
        dest: "{{ diag_dir }}/diagnostics-{{ diag_timestamp }}.tar.gz"
        format: gz
      register: diag_archive

    - name: Calculate archive size
      shell: |
        du -sh {{ diag_archive.dest }} | awk '{print $1}'
      register: archive_size
      changed_when: false

    - name: Count error occurrences
      shell: |
        wc -l {{ diag_dir }}/{{ diag_timestamp }}/error-files.txt | awk '{print $1}'
      register: error_count
      changed_when: false

    - name: Generate diagnostics report
      set_fact:
        diag_report:
          timestamp: "{{ ansible_date_time.iso8601 }}"
          diag_id: "{{ diag_timestamp }}"
          hostname: "{{ inventory_hostname }}"
          archive_path: "{{ diag_archive.dest }}"
          archive_size: "{{ archive_size.stdout }}"
          log_hours_collected: "{{ log_hours }}"
          error_files_found: "{{ error_count.stdout }}"
          components_collected:
            - system_info
            - docker
            - rabbitmq
            - mariadb_galera
            - nova
            - neutron
            - cinder
            - haproxy
            - network
          status: "success"

    - name: Display diagnostics summary
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘        DIAGNOSTICS COLLECTION SUMMARY                      â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ğŸ“… Timestamp: {{ diag_report.timestamp }}
          ğŸ†” Diagnostic ID: {{ diag_report.diag_id }}
          ğŸ–¥ï¸  Host: {{ diag_report.hostname }}
          
          ğŸ“¦ Archive: {{ diag_report.archive_path }}
          ğŸ’¾ Size: {{ diag_report.archive_size }}
          â° Log Period: Last {{ diag_report.log_hours_collected }} hours
          
          âš ï¸  Error Files Found: {{ diag_report.error_files_found }}
          
          âœ… Components Collected:
          {{ diag_report.components_collected | join('\n   ') }}
          
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    - name: Save diagnostics report
      copy:
        content: "{{ diag_report | to_nice_json }}"
        dest: "/var/log/autosphere/diagnostics_{{ diag_timestamp }}.json"
      delegate_to: localhost

    - name: Clean old diagnostic archives (keep last 10)
      shell: |
        cd {{ diag_dir }} && ls -t diagnostics-*.tar.gz | tail -n +11 | xargs -r rm
      ignore_errors: yes
      changed_when: false
