---
# OpenStack Health Check Playbook
# Comprehensive health monitoring for AutoSphere self-healing
# Outputs structured JSON for LLM decision-making

- name: OpenStack Services Health Check
  hosts: openstack_controllers
  gather_facts: yes
  become: yes
  vars:
    health_status: {}
    critical_services:
      - nova-api
      - nova-scheduler
      - nova-conductor
      - nova-compute
      - neutron-server
      - neutron-l3-agent
      - neutron-dhcp-agent
      - neutron-openvswitch-agent
      - cinder-api
      - cinder-scheduler
      - cinder-volume
      - glance-api
      - keystone
      - rabbitmq-server
      - mariadb

  tasks:
    - name: Check RabbitMQ cluster status
      shell: |
        docker exec rabbitmq rabbitmqctl cluster_status --formatter json
      register: rabbitmq_status
      ignore_errors: yes
      changed_when: false

    - name: Parse RabbitMQ health
      set_fact:
        rabbitmq_healthy: "{{ (rabbitmq_status.rc == 0) and ('running' in rabbitmq_status.stdout) }}"

    - name: Check MariaDB/Galera cluster status
      shell: |
        docker exec mariadb mysql -e "SHOW STATUS LIKE 'wsrep_cluster_size';" | grep wsrep_cluster_size | awk '{print $2}'
      register: galera_cluster_size
      ignore_errors: yes
      changed_when: false

    - name: Check OpenStack service containers
      shell: |
        docker ps --filter "name={{ item }}" --format "{% raw %}{{.Status}}{% endraw %}"
      register: container_status
      loop: "{{ critical_services }}"
      ignore_errors: yes
      changed_when: false

    - name: Check Nova compute service status
      shell: |
        docker exec nova_api nova-manage service list | grep -E "nova-compute|nova-scheduler|nova-conductor"
      register: nova_services
      ignore_errors: yes
      changed_when: false

    - name: Check Neutron agents status
      shell: |
        docker exec neutron_server neutron agent-list -f json
      register: neutron_agents
      ignore_errors: yes
      changed_when: false

    - name: Check Cinder services status
      shell: |
        docker exec cinder_api cinder service-list --binary cinder-volume
      register: cinder_services
      ignore_errors: yes
      changed_when: false

    - name: Check API endpoints
      uri:
        url: "{{ item.url }}"
        method: GET
        status_code: [200, 300]
        validate_certs: no
      register: api_health
      loop:
        - { name: "keystone", url: "http://{{ ansible_default_ipv4.address }}:5000/v3" }
        - { name: "nova", url: "http://{{ ansible_default_ipv4.address }}:8774/v2.1" }
        - { name: "neutron", url: "http://{{ ansible_default_ipv4.address }}:9696/v2.0" }
        - { name: "cinder", url: "http://{{ ansible_default_ipv4.address }}:8776/v3" }
        - { name: "glance", url: "http://{{ ansible_default_ipv4.address }}:9292/v2" }
      ignore_errors: yes

    - name: Check for timeout errors in logs (last 10 minutes)
      shell: |
        find /var/log/kolla -name "*.log" -mmin -10 -exec grep -l "TimeoutError\|MessagingTimeout\|ConnectionRefused" {} \; | head -20
      register: timeout_errors
      changed_when: false

    - name: Check RabbitMQ connection errors
      shell: |
        docker logs rabbitmq --since 10m 2>&1 | grep -c "connection_closed\|channel_error" || true
      register: rabbitmq_errors
      changed_when: false

    - name: Identify cascading failures
      set_fact:
        cascade_pattern: >-
          {{ (not rabbitmq_healthy) and 
             (nova_services.rc != 0 or neutron_agents.rc != 0 or cinder_services.rc != 0) }}

    - name: Determine severity level
      set_fact:
        severity_level: >-
          {{ 'critical' if cascade_pattern else 
             ('high' if timeout_errors.stdout_lines | length > 10 else 
             ('medium' if timeout_errors.stdout_lines | length > 5 else 
             ('low' if timeout_errors.stdout_lines | length > 0 else 'healthy'))) }}

    - name: Determine recommended action
      set_fact:
        recommended_action: >-
          {{ 'IMMEDIATE: Run autosphere-fix-cascade template (ID: 14)' if cascade_pattern else
             ('URGENT: Investigate timeout errors and consider RabbitMQ restart (template ID: 11)' if timeout_errors.stdout_lines | length > 10 else
             ('MONITOR: Check logs for patterns' if timeout_errors.stdout_lines | length > 0 else
             'NONE: System healthy')) }}

    - name: Calculate confidence score
      set_fact:
        confidence_score: >-
          {{ 0.95 if cascade_pattern else
             (0.80 if timeout_errors.stdout_lines | length > 10 else
             (0.60 if timeout_errors.stdout_lines | length > 5 else 0.30)) }}

    - name: Generate LLM-friendly health report
      set_fact:
        openstack_health:
          meta:
            report_type: "openstack_health_check"
            timestamp: "{{ ansible_date_time.iso8601 }}"
            hostname: "{{ inventory_hostname }}"
            playbook_version: "1.0.0"
            execution_id: "{{ ansible_date_time.epoch }}"
          status:
            overall: "{{ 'critical' if cascade_pattern else ('warning' if timeout_errors.stdout_lines | length > 0 else 'healthy') }}"
            severity: "{{ severity_level }}"
            confidence: "{{ confidence_score | float }}"
          components:
            rabbitmq:
              status: "{{ 'healthy' if rabbitmq_healthy else 'critical' }}"
              healthy: "{{ rabbitmq_healthy }}"
              error_count: "{{ rabbitmq_errors.stdout | int }}"
              impact: "high"
            galera:
              status: "{{ 'healthy' if (galera_cluster_size.stdout | default('0') | int >= 3) else 'warning' }}"
              cluster_size: "{{ galera_cluster_size.stdout | default('unknown') }}"
              expected_size: 3
              impact: "critical"
            nova:
              status: "{{ 'healthy' if nova_services.rc == 0 else 'critical' }}"
              services_down: "{{ 'unknown' if nova_services.rc != 0 else 0 }}"
              impact: "high"
            neutron:
              status: "{{ 'healthy' if neutron_agents.rc == 0 else 'critical' }}"
              agents_down: "{{ 'unknown' if neutron_agents.rc != 0 else 0 }}"
              impact: "high"
            cinder:
              status: "{{ 'healthy' if cinder_services.rc == 0 else 'warning' }}"
              services_down: "{{ 'unknown' if cinder_services.rc != 0 else 0 }}"
              impact: "medium"
            apis:
              healthy_count: "{{ api_health.results | selectattr('status', 'in', [200, 300]) | list | length }}"
              unhealthy_count: "{{ api_health.results | rejectattr('status', 'in', [200, 300]) | list | length }}"
              total_count: 5
              unhealthy_services: "{{ api_health.results | rejectattr('status', 'in', [200, 300]) | map(attribute='item.name') | list }}"
          errors:
            timeout_files_count: "{{ timeout_errors.stdout_lines | length }}"
            timeout_sample: "{{ timeout_errors.stdout_lines[:3] }}"
            rabbitmq_errors: "{{ rabbitmq_errors.stdout | int }}"
          detection:
            cascade_failure: "{{ cascade_pattern }}"
            cascade_confidence: "{{ 0.95 if cascade_pattern else 0.0 }}"
            root_cause: "{{ 'rabbitmq_failure' if (not rabbitmq_healthy) else ('timeout_cascade' if timeout_errors.stdout_lines | length > 10 else 'none') }}"
          decision:
            action_required: "{{ cascade_pattern or (timeout_errors.stdout_lines | length > 5) }}"
            recommended_template: "{{ 'autosphere-fix-cascade' if cascade_pattern else ('autosphere-rabbitmq-restart' if timeout_errors.stdout_lines | length > 10 else 'none') }}"
            recommended_template_id: "{{ 14 if cascade_pattern else (11 if timeout_errors.stdout_lines | length > 10 else 0) }}"
            priority: "{{ 'immediate' if cascade_pattern else ('high' if timeout_errors.stdout_lines | length > 10 else ('medium' if timeout_errors.stdout_lines | length > 0 else 'none')) }}"
            reasoning: "{{ recommended_action }}"
            expected_outcome: "{{ 'Full service recovery' if cascade_pattern else ('Restored messaging' if timeout_errors.stdout_lines | length > 10 else 'Continued monitoring') }}"

    - name: Save LLM-friendly JSON report
      copy:
        content: "{{ openstack_health | to_nice_json }}"
        dest: "/var/log/autosphere/health_{{ ansible_date_time.epoch }}.json"
      delegate_to: localhost

    - name: Output parseable summary for AWX
      debug:
        msg: |
          === AUTOSPHERE HEALTH CHECK RESULT ===
          STATUS={{ openstack_health.status.overall | upper }}
          SEVERITY={{ openstack_health.status.severity | upper }}
          CONFIDENCE={{ openstack_health.status.confidence }}
          CASCADE_FAILURE={{ openstack_health.detection.cascade_failure }}
          ROOT_CAUSE={{ openstack_health.detection.root_cause }}
          ACTION_REQUIRED={{ openstack_health.decision.action_required }}
          RECOMMENDED_TEMPLATE={{ openstack_health.decision.recommended_template }}
          TEMPLATE_ID={{ openstack_health.decision.recommended_template_id }}
          PRIORITY={{ openstack_health.decision.priority | upper }}
          REASONING={{ openstack_health.decision.reasoning }}
          REPORT_FILE=/var/log/autosphere/health_{{ ansible_date_time.epoch }}.json
          === END HEALTH CHECK RESULT ===

    - name: Display human-readable summary
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘        OPENSTACK HEALTH CHECK SUMMARY                      â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          
          ğŸ“… Timestamp: {{ openstack_health.meta.timestamp }}
          ğŸ–¥ï¸  Host: {{ openstack_health.meta.hostname }}
          
          âš¡ OVERALL STATUS: {{ openstack_health.status.overall | upper }}
          ğŸ¯ SEVERITY: {{ openstack_health.status.severity | upper }}
          ğŸ“Š CONFIDENCE: {{ (openstack_health.status.confidence | float * 100) | round(0) }}%
          
          ğŸ° RabbitMQ: {{ openstack_health.components.rabbitmq.status | upper }}
          ğŸ’¾ Galera: {{ openstack_health.components.galera.status | upper }}
          ğŸ’» Nova: {{ openstack_health.components.nova.status | upper }}
          ğŸŒ Neutron: {{ openstack_health.components.neutron.status | upper }}
          ğŸ’¿ Cinder: {{ openstack_health.components.cinder.status | upper }}
          
          ğŸ”¥ CASCADE FAILURE: {{ 'YES' if openstack_health.detection.cascade_failure else 'NO' }}
          
          ğŸ’¡ RECOMMENDED ACTION:
          Priority: {{ openstack_health.decision.priority | upper }}
          {{ openstack_health.decision.reasoning }}
          {% if openstack_health.decision.recommended_template_id | int > 0 %}
          Execute: {{ openstack_health.decision.recommended_template }} (Template ID: {{ openstack_health.decision.recommended_template_id }})
          {% endif %}
          
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    - name: Fail if critical (for AWX conditional workflows)
      fail:
        msg: |
          CRITICAL: {{ openstack_health.decision.reasoning }}
          Execute template ID {{ openstack_health.decision.recommended_template_id }} immediately.
      when: openstack_health.status.overall == 'critical'
