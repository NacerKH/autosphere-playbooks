---
# Complete Compute Services Snapshot Playbook
# Creates comprehensive snapshots of all OpenStack compute services
# Includes: Nova, Neutron, Cinder, configurations, databases, and states
# Part of AutoSphere disaster recovery system

- name: Snapshot All Compute Services
  hosts: openstack_controllers:openstack_compute
  gather_facts: yes
  become: yes
  vars:
    snapshot_name: "{{ snapshot_id | default('auto-' + ansible_date_time.epoch) }}"
    snapshot_dir: "/var/backups/autosphere/compute-snapshots"
    snapshot_path: "{{ snapshot_dir }}/{{ snapshot_name }}"
    include_volumes: "{{ snapshot_volumes | default(true) }}"
    include_databases: "{{ snapshot_databases | default(true) }}"
    include_configurations: "{{ snapshot_configs | default(true) }}"
    include_service_states: "{{ snapshot_states | default(true) }}"
    snapshot_stages:
      preparation: { status: "pending", start_time: "", end_time: "", duration: 0 }
      volumes: { status: "pending", start_time: "", end_time: "", duration: 0 }
      databases: { status: "pending", start_time: "", end_time: "", duration: 0 }
      configurations: { status: "pending", start_time: "", end_time: "", duration: 0 }
      service_states: { status: "pending", start_time: "", end_time: "", duration: 0 }
      verification: { status: "pending", start_time: "", end_time: "", duration: 0 }

  tasks:
    # STAGE 1: PREPARATION
    - name: "STAGE 1 - START - Prepare snapshot environment"
      set_fact:
        stage1_start: "{{ ansible_date_time.epoch }}"

    - name: Create snapshot directory structure
      file:
        path: "{{ item }}"
        state: directory
        mode: '0750'
      loop:
        - "{{ snapshot_path }}"
        - "{{ snapshot_path }}/volumes"
        - "{{ snapshot_path }}/databases"
        - "{{ snapshot_path }}/configs"
        - "{{ snapshot_path }}/states"
        - "{{ snapshot_path }}/metadata"

    - name: Check available disk space
      shell: |
        df -BG {{ snapshot_dir }} | tail -1 | awk '{print $4}' | sed 's/G//'
      register: available_space
      changed_when: false

    - name: Fail if insufficient space
      fail:
        msg: "Insufficient disk space. Available: {{ available_space.stdout }}GB. Recommended: >50GB"
      when: available_space.stdout | int < 50

    - name: Get current OpenStack service status
      shell: |
        docker ps --filter "name={{ item }}" --format "{{.Names}}:{{.Status}}" || echo "{{ item }}:not_found"
      loop:
        - nova_api
        - nova_scheduler
        - nova_conductor
        - nova_compute
        - neutron_server
        - neutron_l3_agent
        - neutron_dhcp_agent
        - neutron_openvswitch_agent
        - cinder_api
        - cinder_scheduler
        - cinder_volume
      register: service_status_check
      changed_when: false

    - name: "STAGE 1 - END - Update preparation stage"
      set_fact:
        stage1_end: "{{ ansible_date_time.epoch }}"
        snapshot_stages: "{{ snapshot_stages | combine({'preparation': {'status': 'complete', 'start_time': stage1_start, 'end_time': ansible_date_time.epoch, 'duration': (ansible_date_time.epoch | int - stage1_start | int)}}) }}"

    # STAGE 2: VOLUME SNAPSHOTS
    - name: "STAGE 2 - START - Snapshot Cinder volumes"
      set_fact:
        stage2_start: "{{ ansible_date_time.epoch }}"
      when: include_volumes

    - name: Get list of all active volumes
      shell: |
        docker exec cinder_api openstack volume list --all-projects -f json
      register: volumes_list
      changed_when: false
      run_once: true
      when: include_volumes

    - name: Parse volumes list
      set_fact:
        active_volumes: "{{ volumes_list.stdout | from_json }}"
      run_once: true
      when: include_volumes and volumes_list.rc == 0

    - name: Create snapshots for all volumes
      shell: |
        docker exec cinder_api openstack volume snapshot create \
          --volume {{ item.ID }} \
          --force \
          "{{ snapshot_name }}-{{ item.Name | default(item.ID) }}" \
          -f json
      loop: "{{ active_volumes }}"
      register: volume_snapshots
      when: include_volumes and active_volumes is defined
      ignore_errors: yes
      run_once: true

    - name: Save volume snapshot mapping
      copy:
        content: |
          # Volume Snapshot Mapping
          # Created: {{ ansible_date_time.iso8601 }}
          # Snapshot Set: {{ snapshot_name }}

          {% for result in volume_snapshots.results | default([]) %}
          {% if result.rc == 0 %}
          {{ (result.stdout | from_json).volume_id }}:{{ (result.stdout | from_json).id }}:{{ (result.stdout | from_json).name }}
          {% endif %}
          {% endfor %}
        dest: "{{ snapshot_path }}/volumes/snapshot-mapping.txt"
      when: include_volumes and volume_snapshots is defined
      delegate_to: localhost

    - name: Export volume metadata
      shell: |
        docker exec cinder_api openstack volume list --all-projects --long -f json > {{ snapshot_path }}/volumes/volumes-metadata.json
      when: include_volumes
      run_once: true

    - name: "STAGE 2 - END - Update volumes stage"
      set_fact:
        stage2_end: "{{ ansible_date_time.epoch }}"
        snapshot_stages: "{{ snapshot_stages | combine({'volumes': {'status': 'complete', 'start_time': stage2_start, 'end_time': ansible_date_time.epoch, 'duration': (ansible_date_time.epoch | int - stage2_start | int)}}) }}"
      when: include_volumes

    - name: "STAGE 2 - SKIPPED"
      set_fact:
        snapshot_stages: "{{ snapshot_stages | combine({'volumes': {'status': 'skipped', 'start_time': '', 'end_time': '', 'duration': 0}}) }}"
      when: not include_volumes

    # STAGE 3: DATABASE SNAPSHOTS
    - name: "STAGE 3 - START - Snapshot databases"
      set_fact:
        stage3_start: "{{ ansible_date_time.epoch }}"
      when: include_databases
      run_once: true

    - name: Dump Nova database
      shell: |
        docker exec mariadb mysqldump nova --single-transaction --quick --lock-tables=false | gzip > {{ snapshot_path }}/databases/nova.sql.gz
      register: nova_db_dump
      when: include_databases
      run_once: true

    - name: Dump Neutron database
      shell: |
        docker exec mariadb mysqldump neutron --single-transaction --quick --lock-tables=false | gzip > {{ snapshot_path }}/databases/neutron.sql.gz
      register: neutron_db_dump
      when: include_databases
      run_once: true

    - name: Dump Cinder database
      shell: |
        docker exec mariadb mysqldump cinder --single-transaction --quick --lock-tables=false | gzip > {{ snapshot_path }}/databases/cinder.sql.gz
      register: cinder_db_dump
      when: include_databases
      run_once: true

    - name: Dump Placement database
      shell: |
        docker exec mariadb mysqldump placement --single-transaction --quick --lock-tables=false | gzip > {{ snapshot_path }}/databases/placement.sql.gz
      register: placement_db_dump
      ignore_errors: yes
      when: include_databases
      run_once: true

    - name: Create database checksums
      shell: |
        cd {{ snapshot_path }}/databases
        md5sum *.sql.gz > checksums.md5
      when: include_databases
      run_once: true

    - name: "STAGE 3 - END - Update databases stage"
      set_fact:
        stage3_end: "{{ ansible_date_time.epoch }}"
        snapshot_stages: "{{ snapshot_stages | combine({'databases': {'status': 'complete', 'start_time': stage3_start, 'end_time': ansible_date_time.epoch, 'duration': (ansible_date_time.epoch | int - stage3_start | int)}}) }}"
      when: include_databases

    - name: "STAGE 3 - SKIPPED"
      set_fact:
        snapshot_stages: "{{ snapshot_stages | combine({'databases': {'status': 'skipped', 'start_time': '', 'end_time': '', 'duration': 0}}) }}"
      when: not include_databases

    # STAGE 4: CONFIGURATION SNAPSHOTS
    - name: "STAGE 4 - START - Snapshot configurations"
      set_fact:
        stage4_start: "{{ ansible_date_time.epoch }}"
      when: include_configurations

    - name: Backup Kolla configuration
      archive:
        path: /etc/kolla
        dest: "{{ snapshot_path }}/configs/kolla-config.tar.gz"
        format: gz
      when: include_configurations

    - name: Export Nova configuration from containers
      shell: |
        for container in nova_api nova_scheduler nova_conductor nova_compute; do
          docker exec $container cat /etc/nova/nova.conf > {{ snapshot_path }}/configs/${container}-nova.conf 2>/dev/null || true
        done
      when: include_configurations

    - name: Export Neutron configuration from containers
      shell: |
        for container in neutron_server neutron_l3_agent neutron_dhcp_agent neutron_openvswitch_agent; do
          docker exec $container cat /etc/neutron/neutron.conf > {{ snapshot_path }}/configs/${container}-neutron.conf 2>/dev/null || true
        done
      when: include_configurations

    - name: Export Cinder configuration from containers
      shell: |
        for container in cinder_api cinder_scheduler cinder_volume; do
          docker exec $container cat /etc/cinder/cinder.conf > {{ snapshot_path }}/configs/${container}-cinder.conf 2>/dev/null || true
        done
      when: include_configurations

    - name: Backup OVS configuration
      shell: |
        ovs-vsctl show > {{ snapshot_path }}/configs/ovs-config.txt 2>/dev/null || true
        ovs-vsctl list-br > {{ snapshot_path }}/configs/ovs-bridges.txt 2>/dev/null || true
      when: include_configurations
      ignore_errors: yes

    - name: "STAGE 4 - END - Update configurations stage"
      set_fact:
        stage4_end: "{{ ansible_date_time.epoch }}"
        snapshot_stages: "{{ snapshot_stages | combine({'configurations': {'status': 'complete', 'start_time': stage4_start, 'end_time': ansible_date_time.epoch, 'duration': (ansible_date_time.epoch | int - stage4_start | int)}}) }}"
      when: include_configurations

    - name: "STAGE 4 - SKIPPED"
      set_fact:
        snapshot_stages: "{{ snapshot_stages | combine({'configurations': {'status': 'skipped', 'start_time': '', 'end_time': '', 'duration': 0}}) }}"
      when: not include_configurations

    # STAGE 5: SERVICE STATES
    - name: "STAGE 5 - START - Capture service states"
      set_fact:
        stage5_start: "{{ ansible_date_time.epoch }}"
      when: include_service_states
      run_once: true

    - name: Capture Nova service states
      shell: |
        docker exec nova_api nova-manage service list > {{ snapshot_path }}/states/nova-services.txt 2>/dev/null || true
        docker exec nova_api openstack compute service list -f json > {{ snapshot_path }}/states/nova-services.json 2>/dev/null || true
        docker exec nova_api openstack hypervisor list -f json > {{ snapshot_path }}/states/hypervisors.json 2>/dev/null || true
      when: include_service_states
      run_once: true

    - name: Capture Neutron agent states
      shell: |
        docker exec neutron_server neutron agent-list > {{ snapshot_path }}/states/neutron-agents.txt 2>/dev/null || true
        docker exec neutron_server openstack network agent list -f json > {{ snapshot_path }}/states/neutron-agents.json 2>/dev/null || true
      when: include_service_states
      run_once: true

    - name: Capture Cinder service states
      shell: |
        docker exec cinder_api cinder service-list > {{ snapshot_path }}/states/cinder-services.txt 2>/dev/null || true
        docker exec cinder_api openstack volume service list -f json > {{ snapshot_path }}/states/cinder-services.json 2>/dev/null || true
      when: include_service_states
      run_once: true

    - name: Capture instance states
      shell: |
        docker exec nova_api openstack server list --all-projects --long -f json > {{ snapshot_path }}/states/instances.json 2>/dev/null || true
      when: include_service_states
      run_once: true

    - name: Capture network topology
      shell: |
        docker exec neutron_server openstack network list --long -f json > {{ snapshot_path }}/states/networks.json 2>/dev/null || true
        docker exec neutron_server openstack subnet list -f json > {{ snapshot_path }}/states/subnets.json 2>/dev/null || true
        docker exec neutron_server openstack router list -f json > {{ snapshot_path }}/states/routers.json 2>/dev/null || true
        docker exec neutron_server openstack floating ip list -f json > {{ snapshot_path }}/states/floating-ips.json 2>/dev/null || true
      when: include_service_states
      run_once: true

    - name: Capture Docker container states
      shell: |
        docker ps -a --format "table {{.Names}}\t{{.Status}}\t{{.Image}}" > {{ snapshot_path }}/states/docker-containers.txt
      when: include_service_states

    - name: "STAGE 5 - END - Update service states stage"
      set_fact:
        stage5_end: "{{ ansible_date_time.epoch }}"
        snapshot_stages: "{{ snapshot_stages | combine({'service_states': {'status': 'complete', 'start_time': stage5_start, 'end_time': ansible_date_time.epoch, 'duration': (ansible_date_time.epoch | int - stage5_start | int)}}) }}"
      when: include_service_states

    - name: "STAGE 5 - SKIPPED"
      set_fact:
        snapshot_stages: "{{ snapshot_stages | combine({'service_states': {'status': 'skipped', 'start_time': '', 'end_time': '', 'duration': 0}}) }}"
      when: not include_service_states

    # STAGE 6: VERIFICATION
    - name: "STAGE 6 - START - Verify snapshot integrity"
      set_fact:
        stage6_start: "{{ ansible_date_time.epoch }}"
      run_once: true

    - name: Calculate snapshot size
      shell: |
        du -sh {{ snapshot_path }} | awk '{print $1}'
      register: snapshot_size
      changed_when: false
      run_once: true

    - name: Count volume snapshots created
      shell: |
        wc -l < {{ snapshot_path }}/volumes/snapshot-mapping.txt 2>/dev/null || echo "0"
      register: snapshot_count
      changed_when: false
      when: include_volumes
      run_once: true

    - name: Verify database dumps
      shell: |
        ls -lh {{ snapshot_path }}/databases/*.sql.gz 2>/dev/null | wc -l || echo "0"
      register: db_dumps_count
      changed_when: false
      when: include_databases
      run_once: true

    - name: Verify configuration files
      shell: |
        ls -lh {{ snapshot_path }}/configs/*.conf 2>/dev/null | wc -l || echo "0"
      register: config_files_count
      changed_when: false
      when: include_configurations
      run_once: true

    - name: Create snapshot manifest
      copy:
        content: |
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          AUTOSPHERE COMPUTE SERVICES SNAPSHOT MANIFEST
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          Snapshot ID: {{ snapshot_name }}
          Created: {{ ansible_date_time.iso8601 }}
          Hostname: {{ inventory_hostname }}
          Total Size: {{ snapshot_size.stdout }}

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          COMPONENTS INCLUDED
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

          âœ“ Volumes: {{ 'YES - ' + snapshot_count.stdout + ' snapshots' if include_volumes else 'NO' }}
          âœ“ Databases: {{ 'YES - ' + db_dumps_count.stdout + ' dumps' if include_databases else 'NO' }}
          âœ“ Configurations: {{ 'YES - ' + config_files_count.stdout + ' files' if include_configurations else 'NO' }}
          âœ“ Service States: {{ 'YES' if include_service_states else 'NO' }}

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          SNAPSHOT CONTENTS
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

          ğŸ“ volumes/
             â””â”€ snapshot-mapping.txt      Volume â†’ Snapshot mapping
             â””â”€ volumes-metadata.json     Volume details

          ğŸ“ databases/
             â””â”€ nova.sql.gz              Nova database dump
             â””â”€ neutron.sql.gz           Neutron database dump
             â””â”€ cinder.sql.gz            Cinder database dump
             â””â”€ placement.sql.gz         Placement database dump
             â””â”€ checksums.md5            Database checksums

          ğŸ“ configs/
             â””â”€ kolla-config.tar.gz      Kolla configuration
             â””â”€ *-nova.conf              Nova configs per container
             â””â”€ *-neutron.conf           Neutron configs per container
             â””â”€ *-cinder.conf            Cinder configs per container
             â””â”€ ovs-*.txt                OVS configurations

          ğŸ“ states/
             â””â”€ nova-services.*          Nova service states
             â””â”€ neutron-agents.*         Neutron agent states
             â””â”€ cinder-services.*        Cinder service states
             â””â”€ instances.json           VM instances state
             â””â”€ networks.json            Network topology
             â””â”€ floating-ips.json        Floating IP allocations
             â””â”€ docker-containers.txt    Container states

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          EXECUTION TIMELINE
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

          {% for stage, data in snapshot_stages.items() %}
          {{ stage | upper }}: {{ data.status | upper }} ({{ data.duration }}s)
          {% endfor %}

          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
          RESTORE INSTRUCTIONS
          â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

          To restore from this snapshot, run:

          ansible-playbook rollback-compute-services.yml \
            -e "snapshot_name={{ snapshot_name }}"

          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        dest: "{{ snapshot_path }}/MANIFEST.txt"
      run_once: true

    - name: Determine snapshot success
      set_fact:
        snapshot_success: true
      run_once: true

    - name: "STAGE 6 - END - Update verification stage"
      set_fact:
        stage6_end: "{{ ansible_date_time.epoch }}"
        snapshot_stages: "{{ snapshot_stages | combine({'verification': {'status': 'complete', 'start_time': stage6_start, 'end_time': ansible_date_time.epoch, 'duration': (ansible_date_time.epoch | int - stage6_start | int)}}) }}"

    - name: Calculate total execution time
      set_fact:
        total_duration: "{{ stage6_end | int - stage1_start | int }}"

    - name: Generate snapshot report
      set_fact:
        snapshot_report:
          meta:
            report_type: "compute_services_snapshot"
            timestamp: "{{ ansible_date_time.iso8601 }}"
            hostname: "{{ inventory_hostname }}"
            execution_id: "{{ ansible_date_time.epoch }}"
            snapshot_id: "{{ snapshot_name }}"
            snapshot_path: "{{ snapshot_path }}"
            playbook_version: "1.0.0"
            total_duration_seconds: "{{ total_duration | int }}"
          configuration:
            include_volumes: "{{ include_volumes }}"
            include_databases: "{{ include_databases }}"
            include_configurations: "{{ include_configurations }}"
            include_service_states: "{{ include_service_states }}"
          execution:
            stages_completed: 6
            stages:
              preparation: "{{ snapshot_stages.preparation }}"
              volumes: "{{ snapshot_stages.volumes }}"
              databases: "{{ snapshot_stages.databases }}"
              configurations: "{{ snapshot_stages.configurations }}"
              service_states: "{{ snapshot_stages.service_states }}"
              verification: "{{ snapshot_stages.verification }}"
          results:
            total_size: "{{ snapshot_size.stdout }}"
            volume_snapshots_created: "{{ snapshot_count.stdout | default(0) | int }}"
            database_dumps_created: "{{ db_dumps_count.stdout | default(0) | int }}"
            config_files_backed_up: "{{ config_files_count.stdout | default(0) | int }}"
            manifest_created: true
          status:
            overall: "success"
            snapshot_complete: true
            confidence: 0.98
          decision:
            action_taken: "compute_services_snapshot_created"
            next_recommended_action: "Snapshot ready for rollback if needed"
            snapshot_available_for_restore: true
            restore_command: "ansible-playbook rollback-compute-services.yml -e snapshot_name={{ snapshot_name }}"
      run_once: true

    - name: Save snapshot report
      copy:
        content: "{{ snapshot_report | to_nice_json }}"
        dest: "{{ snapshot_path }}/metadata/snapshot-report.json"
      run_once: true

    - name: Create symlink to latest snapshot
      file:
        src: "{{ snapshot_path }}"
        dest: "{{ snapshot_dir }}/latest"
        state: link
        force: yes
      run_once: true

    - name: Output parseable summary for AWX
      debug:
        msg: |
          === AUTOSPHERE COMPUTE SNAPSHOT RESULT ===
          STATUS={{ snapshot_report.status.overall | upper }}
          SNAPSHOT_ID={{ snapshot_report.meta.snapshot_id }}
          SNAPSHOT_PATH={{ snapshot_report.meta.snapshot_path }}
          TOTAL_SIZE={{ snapshot_report.results.total_size }}
          VOLUME_SNAPSHOTS={{ snapshot_report.results.volume_snapshots_created }}
          DATABASE_DUMPS={{ snapshot_report.results.database_dumps_created }}
          CONFIG_FILES={{ snapshot_report.results.config_files_backed_up }}
          DURATION={{ snapshot_report.meta.total_duration_seconds }}s
          RESTORE_COMMAND={{ snapshot_report.decision.restore_command }}
          === END COMPUTE SNAPSHOT RESULT ===
      run_once: true

    - name: Display human-readable summary
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘      COMPUTE SERVICES SNAPSHOT - COMPLETE                  â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

          ğŸ“… Timestamp: {{ snapshot_report.meta.timestamp }}
          ğŸ†” Snapshot ID: {{ snapshot_report.meta.snapshot_id }}
          ğŸ“ Location: {{ snapshot_report.meta.snapshot_path }}
          ğŸ’¾ Total Size: {{ snapshot_report.results.total_size }}
          â±ï¸  Duration: {{ snapshot_report.meta.total_duration_seconds }}s

          âœ… COMPONENTS SNAPSHOT:
          â””â”€ Volume Snapshots: {{ snapshot_report.results.volume_snapshots_created }}
          â””â”€ Database Dumps: {{ snapshot_report.results.database_dumps_created }}
          â””â”€ Config Files: {{ snapshot_report.results.config_files_backed_up }}
          â””â”€ Service States: {{ 'Captured' if include_service_states else 'Skipped' }}

          ğŸ“Š EXECUTION STAGES: 6/6 COMPLETE

          ğŸ¯ STATUS: {{ snapshot_report.status.overall | upper }}
          ğŸ“ˆ CONFIDENCE: {{ (snapshot_report.status.confidence | float * 100) | round(0) }}%

          ğŸ”„ RESTORE COMMAND:
          {{ snapshot_report.decision.restore_command }}

          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      run_once: true
